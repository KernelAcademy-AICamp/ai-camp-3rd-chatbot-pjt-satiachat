import { Flame, Scale, Pill, Target } from "lucide-react";
import { SummaryCard } from "@/components/dashboard/SummaryCard";
import { QuickActions } from "@/components/dashboard/QuickActions";
import { ChatPanel } from "@/components/dashboard/ChatPanel";
import { TodayMeals } from "@/components/dashboard/TodayMeals";
import { useTodayCalories } from "@/hooks/useMeals";
import { useLatestProgress } from "@/hooks/useProgress";
import { useTodayMedicationStats } from "@/hooks/useMedications";

// Temporary constants until connected to user profile
const TARGET_CALORIES = 1800;
const GOAL_WEIGHT = 68;
const START_WEIGHT = 78;

export default function Dashboard() {
  const today = new Date().toLocaleDateString("en-US", {
    weekday: "long",
    month: "long",
    day: "numeric",
  });

  // Get today's calories from Supabase
  const { totalCalories, isLoading: isLoadingCalories } = useTodayCalories();

  // Get latest weight from Supabase
  const { data: latestProgress, isLoading: isLoadingWeight } = useLatestProgress();

  // Get today's medication stats from Supabase
  const {
    total: medicationsTotal,
    taken: medicationsTaken,
    percentage: medicationPercentage,
    isLoading: isLoadingMeds
  } = useTodayMedicationStats();

  // Calculate values
  const currentWeight = latestProgress?.weight_kg || START_WEIGHT;
  const caloriesProgress = Math.min(100, Math.round((totalCalories / TARGET_CALORIES) * 100));
  const weightProgress = Math.round(((START_WEIGHT - currentWeight) / (START_WEIGHT - GOAL_WEIGHT)) * 100);
  const remainingWeight = currentWeight - GOAL_WEIGHT;

  return (
    <div className="flex flex-col lg:flex-row min-h-screen">
      {/* Main Content */}
      <div className="flex-1 p-4 md:p-6 lg:p-8">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-2xl md:text-3xl font-bold text-foreground">Dashboard</h1>
          <p className="text-muted-foreground mt-1">{today}</p>
        </div>

        {/* Quick Actions */}
        <div className="mb-6">
          <QuickActions />
        </div>

        {/* Summary Cards */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <SummaryCard
            title="Calories"
            value={isLoadingCalories ? "..." : totalCalories.toLocaleString()}
            subtitle={`of ${TARGET_CALORIES.toLocaleString()} kcal`}
            icon={Flame}
            progress={isLoadingCalories ? 0 : caloriesProgress}
            variant="default"
          />
          <SummaryCard
            title="Weight"
            value={isLoadingWeight ? "..." : currentWeight.toFixed(1)}
            subtitle={latestProgress ? "kg • Updated" : "kg • No data"}
            icon={Scale}
            variant="success"
          />
          <SummaryCard
            title="Medication"
            value={isLoadingMeds ? "..." : `${medicationsTaken}/${medicationsTotal}`}
            subtitle="doses taken"
            icon={Pill}
            progress={isLoadingMeds ? 0 : medicationPercentage}
            variant="warning"
          />
          <SummaryCard
            title="Goal"
            value={`${GOAL_WEIGHT} kg`}
            subtitle={remainingWeight > 0 ? `${remainingWeight.toFixed(1)} kg to go` : "Goal reached!"}
            icon={Target}
            progress={Math.min(100, Math.max(0, weightProgress))}
            variant="info"
          />
        </div>

        {/* Today's Meals */}
        <TodayMeals />
      </div>

      {/* Chat Panel - Desktop */}
      <div className="hidden lg:block w-96 border-l border-border p-4 bg-muted/20">
        <div className="h-[calc(100vh-2rem)] sticky top-4">
          <ChatPanel />
        </div>
      </div>

      {/* Chat Panel - Mobile (simplified floating button would go here) */}
    </div>
  );
}
